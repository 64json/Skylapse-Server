<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sky-Lapse</title>
</head>
<body>
<script>
  let accessToken = null;
  window.fbAsyncInit = function () {
    FB.init({
      appId: '167062520550844',
      autoLogAppEvents: true,
      xfbml: true,
      version: 'v2.11'
    });
    FB.login(function (response) {
      accessToken = response.authResponse.accessToken;
    }, {
      scope: 'publish_actions',
      return_scopes: true
    });
  };

  (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {
      return;
    }
    js = d.createElement(s);
    js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>
<video id="player" controls autoplay></video>
<canvas id="snapshot" width=640 height=480></canvas>
<span id="frames">0</span>
<script src="whammy.js"></script>
<script src="jquery-3.2.1.min.js"></script>
<script>
  /**
   * References
   * -
   * https://github.com/muaz-khan/Ffmpeg.js
   * https://github.com/antimatter15/whammy
   * https://developers.google.com/web/fundamentals/media/capturing-images/
   */

  const FPS = 5;
  const INTERVAL = 500;
  const TIMEOUT = 10000;

  const player = document.getElementById('player');
  const snapshotCanvas = document.getElementById('snapshot');
  const frames = document.getElementById('frames');
  let videoTracks;

  const handleSuccess = function (stream) {
    player.srcObject = stream;
    videoTracks = stream.getVideoTracks();

    const encoder = new Whammy.Video(FPS);

    const timer = setInterval(() => {
      const context = snapshot.getContext('2d');
      context.drawImage(player, 0, 0, snapshotCanvas.width, snapshotCanvas.height);

      encoder.add(snapshotCanvas);
      frames.innerHTML = Number(frames.innerHTML) + 1;
    }, INTERVAL);

    setTimeout(() => {
      videoTracks.forEach(function (track) {
        track.stop()
      });
      clearInterval(timer);
      encoder.compile(false, function (output) {
        convertStreams(output);
      });
    }, TIMEOUT);
  };

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(handleSuccess);

  const workerPath = 'https://archive.org/download/ffmpeg_asm/ffmpeg_asm.js';

  function processInWebWorker() {
    const blob = URL.createObjectURL(new Blob(['importScripts("' + workerPath + '");var now = Date.now;function print(text) {postMessage({"type" : "stdout","data" : text});};onmessage = function(event) {var message = event.data;if (message.type === "command") {var Module = {print: print,printErr: print,files: message.files || [],arguments: message.arguments || [],TOTAL_MEMORY: message.TOTAL_MEMORY || false};postMessage({"type" : "start","data" : Module.arguments.join(" ")});postMessage({"type" : "stdout","data" : "Received command: " +Module.arguments.join(" ") +((Module.TOTAL_MEMORY) ? ".  Processing with " + Module.TOTAL_MEMORY + " bits." : "")});var time = now();var result = ffmpeg_run(Module);var totalTime = now() - time;postMessage({"type" : "stdout","data" : "Finished processing (took " + totalTime + "ms)"});postMessage({"type" : "done","data" : result,"time" : totalTime});}};postMessage({"type" : "ready"});'], {
      type: 'application/javascript'
    }));
    const worker = new Worker(blob);
    URL.revokeObjectURL(blob);
    return worker;
  }

  let worker;

  function convertStreams(webmBlob) {
    let fileReader = new FileReader();
    fileReader.onload = function () {
      worker.postMessage({
        type: 'command',
        arguments: '-i video.webm -c:v mpeg4 -b:v 6400k -strict experimental output.mp4'.split(' '),
        files: [
          {
            data: new Uint8Array(this.result),
            name: 'video.webm'
          }
        ]
      });
    };
    fileReader.readAsArrayBuffer(webmBlob);
    if (!worker) {
      worker = processInWebWorker();
    }
    worker.onmessage = event => {
      const message = event.data;
      switch (message.type) {
        case 'ready':
          console.log('ffmpeg-asm.js file has been loaded.');
          break;
        case 'stdout':
          console.log(message.data);
          break;
        case 'start':
          console.log('ffmpeg-asm.js file received ffmpeg command.');
          break;
        case 'done':
          console.log(message);
          const result = message.data[0];
          const mp4Blob = new File([result.data], 'test.mp4', { type: 'video/mp4' });

          postVideo(mp4Blob);
          window.open(URL.createObjectURL(mp4Blob));
      }
    };
  }

  function postVideo(source) {
    const data = new FormData();
    data.append('access_token', accessToken);
    data.append('source', source);
    data.append('no_story', true);
    $.ajax({
      url: 'https://graph-video.facebook.com/v2.11/me/videos',
      type: 'POST',
      data,
      processData: false,
      contentType: false,
      cache: false,
      success: function (data) {
        console.log(data);
      },
      error: function (shr, status, data) {
        console.error(data);
      },
      complete: function (data) {
        console.log(data);
      }
    });
  }
</script>
</body>
</html>